<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>15 C√¢u Sinh T·ª≠ - NCT9x Master</title>
    <style>
        :root { --gold: #f1c40f; --blue: #3498db; --dark: #020230; --red: #e74c3c; --green: #2ecc71; --purple: #9b59b6; }
        body { margin:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--dark); color:#fff; display:flex; justify-content:center; align-items:center; min-height:100vh; overflow: hidden; user-select: none; }
        
        .box { width: 95%; max-width: 500px; background: #000; border: 2px solid var(--gold); border-radius: 20px; padding: 20px; box-shadow: 0 0 40px rgba(241, 196, 15, 0.2); position: relative; transition: all 0.3s; }
        
        h1 { text-align: center; color: var(--gold); margin: 5px 0 20px 0; text-transform: uppercase; letter-spacing: 1px; font-size: 1.8em; }
        
        /* Input T√™n */
        .input-group { margin-bottom: 20px; text-align: center; }
        input { width: 70%; padding: 12px; background: #111; border: 2px solid #444; color: var(--gold); border-radius: 10px; font-size: 1.2em; outline: none; transition: 0.3s; text-align: center; font-weight: bold; text-transform: capitalize; }
        input:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); }

        /* Lifelines Bar */
        .lifelines { display: flex; justify-content: space-between; margin-bottom: 15px; padding: 0 10px; }
        .life-btn { background: #111; border: 2px solid var(--gold); color: var(--gold); width: 50px; height: 50px; border-radius: 50%; font-size: 1.5em; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; position: relative; }
        .life-btn:hover { background: var(--gold); color: #000; transform: scale(1.1); }
        .life-btn.used { filter: grayscale(1); opacity: 0.4; cursor: not-allowed; border-color: #555; pointer-events: none; }
        .life-btn.used::after { content: '‚ùå'; position: absolute; font-size: 1.2em; color: red; }

        /* Timer & Question */
        #timer { font-size: 2.2em; text-align: center; font-weight: bold; color: var(--red); text-shadow: 0 0 10px var(--red); margin: 5px 0; font-family: monospace; }
        
        .options-grid { display: grid; gap: 10px; margin-top: 15px; }
        .option { padding: 12px; border: 1px solid var(--blue); border-radius: 8px; cursor: pointer; transition: 0.2s; background: rgba(52, 152, 219, 0.1); display: flex; align-items: center; min-height: 40px; }
        .option:hover { background: rgba(52, 152, 219, 0.3); transform: translateX(5px); }
        .option.correct { background: var(--green) !important; border-color: #fff; color: #000; font-weight: bold; animation: pulse 0.5s; }
        .option.wrong { background: var(--red) !important; border-color: #fff; opacity: 0.9; }
        .option.hidden-50 { opacity: 0; pointer-events: none; visibility: hidden; } /* ·∫®n h·∫≥n lu√¥n */

        /* Modal / Overlay for Lifelines */
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 18px; text-align: center; padding: 20px; box-sizing: border-box; }
        #overlay h3 { color: var(--gold); margin-top: 0; font-size: 1.5em; }
        #overlay p { font-size: 1.1em; line-height: 1.5; color: #fff; }
        .close-btn { margin-top: 20px; padding: 10px 30px; background: var(--blue); border: none; color: #fff; border-radius: 5px; cursor: pointer; font-weight: bold; }

        .btn { width: 100%; padding: 14px; margin-top: 20px; border-radius: 8px; border: 2px solid var(--gold); background: var(--gold); color: #000; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; font-size: 1em; }
        .btn:hover { background: #fff; border-color: #fff; box-shadow: 0 0 15px #fff; }

        #explain { color: var(--gold); margin-top: 15px; font-style: italic; text-align: center; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; font-size: 0.9em; }
        .hidden { display: none !important; }
        .nct-signature { text-align: center; font-size: 0.7em; opacity: 0.5; margin-top: 15px; font-style: italic; color: var(--gold); }
        .disabled { pointer-events: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="box">
    <div id="screen-start">
        <h1>üß† 15 C√ÇU H·∫†I N√ÉO</h1>
        <div class="input-group">
            <input type="text" id="inp-name" placeholder="Nh·∫≠p t√™n b·∫°n (VD: Linh)" autocomplete="off" onkeypress="handleEnter(event)">
        </div>
        <div class="rule-list" style="color:#ccc; font-size:0.9em; line-height:1.6; margin-bottom:20px; background:rgba(255,255,255,0.05); padding:15px; border-radius:10px;">
            üíé <b>LU·∫¨T CH∆†I M·ªöI:</b><br>
            ‚Ä¢ To√†n b·ªô l√† c√¢u ƒë·ªë m·∫πo & ƒë·ªë vui.<br>
            ‚Ä¢ 4 quy·ªÅn tr·ª£ gi√∫p c·ª±c m·∫°nh.<br>
            ‚Ä¢ <b>20 gi√¢y</b> suy nghƒ© m·ªói c√¢u.<br>
            ‚Ä¢ V∆∞·ª£t qua c√¢u 15 ƒë·ªÉ th√†nh Huy·ªÅn Tho·∫°i.
        </div>
        <button class="btn" onclick="game.start()">CHI·∫æN NGAY</button>
        <div class="nct-signature">Phi√™n b·∫£n NCT9x Master ‚ú®</div>
    </div>

    <div id="screen-play" class="hidden">
        <div class="lifelines">
            <button class="life-btn" id="btn-5050" onclick="game.life5050()" title="50:50">‚öñÔ∏è</button>
            <button class="life-btn" id="btn-phone" onclick="game.lifePhone()" title="G·ªçi ng∆∞·ªùi th√¢n">üìû</button>
            <button class="life-btn" id="btn-audience" onclick="game.lifeAudience()" title="H·ªèi kh√°n gi·∫£">üë•</button>
            <button class="life-btn" id="btn-expert" onclick="game.lifeExpert()" title="T·ªï t∆∞ v·∫•n">üßô</button>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; color: var(--gold); border-bottom: 1px solid #333; padding-bottom: 5px;">
            <span id="player-display" style="font-weight: bold;"></span>
            <span id="progress" style="font-size:0.9em;">C√ÇU 1/15</span>
        </div>
        
        <div id="timer">20</div>
        <p id="question" style="font-size: 1.2em; text-align: center; min-height: 60px; font-weight: 500; margin: 10px 0;"></p>
        
        <div class="options-grid" id="options"></div>
        <div id="explain" class="hidden"></div>
    </div>

    <div id="overlay" class="hidden">
        <h3 id="overlay-title"></h3>
        <div id="overlay-content"></div>
        <button class="close-btn" onclick="game.closeOverlay()">ƒê√É HI·ªÇU</button>
    </div>

    <div id="screen-result" class="hidden">
        <h1 id="res-title" style="font-size: 2em;"></h1>
        <p id="res-msg" style="text-align: center; line-height: 1.6; font-size: 1.1em; padding: 10px;"></p>
        <button class="btn" onclick="location.reload()">CH∆†I L·∫†I T·ª™ ƒê·∫¶U</button>
        <div class="nct-signature">NCT9x ch√∫c b·∫°n may m·∫Øn l·∫ßn sau ‚ú®</div>
    </div>
</div>

<script>
/* ================== DATABASE M·ªöI (ƒê·ªê M·∫∏O & H·∫†I N√ÉO) ================== */
const DB = [
    // EASY (Kh·ªüi ƒë·ªông nh·∫π nh√†ng)
    {l:"easy", q:"C·∫Øm v√†o run r·∫©y to√†n th√¢n / R√∫t ra n∆∞·ªõc ch·∫£y t·ª´ ch√¢n xu·ªëng s√†n... L√† c√°i g√¨?", o:["C√°i t·ªß l·∫°nh", "C√°i m√°y b∆°m", "C√°i ƒëi·ªÅu h√≤a", "C√°i b√†n ·ªßi"], c:0},
    {l:"easy", q:"·ªû Vi·ªát Nam, r·ªìng bay ·ªü ƒë√¢u v√† ƒë√°p ·ªü ƒë√¢u?", o:["Bay ·ªü H√† N·ªôi, ƒë√°p ·ªü Qu·∫£ng Ninh", "Bay ·ªü ThƒÉng Long, ƒë√°p ·ªü H·∫° Long", "Bay ·ªü Hu·∫ø, ƒë√°p ·ªü ƒê√† N·∫µng", "Bay ·ªü tr·ªùi, ƒë√°p ·ªü ƒë·∫•t"], c:1},
    {l:"easy", q:"C√¥ n√†o m√† t·∫•t c·∫£ m·ªçi ng∆∞·ªùi ƒë·ªÅu s·ª£, kh√¥ng ch·ªâ ri√™ng h·ªçc sinh?", o:["C√¥ gi√°o", "C√¥ ƒë∆°n", "C√¥ Vy (Corona)", "C√¥ h·ªìn"], c:2},
    {l:"easy", q:"C√°i g√¨ 2 l·ªó: c√≥ gi√≥ th√¨ s·ªëng, kh√¥ng gi√≥ th√¨ ch·∫øt?", o:["L·ªó tai", "L·ªó m≈©i", "C·ª≠a s·ªï", "·ªêng s√°o"], c:1},
    {l:"easy", q:"Nh√† n√†o l·∫°nh l·∫Ωo nh∆∞ng ai c≈©ng mu·ªën t·ªõi?", o:["Nh√† x√°c", "Nh√† ƒë√°", "Nh√† bƒÉng (Ng√¢n h√†ng)", "Nh√† ma"], c:2},
    {l:"easy", q:"Qu·∫£ g√¨ ai c≈©ng s·ª£ ƒÉn tr√∫ng?", o:["Qu·∫£ t·∫°", "Qu·∫£ b√°o", "Qu·∫£ ƒë·∫•m", "Qu·∫£ bom"], c:1},
    {l:"easy", q:"C√°i g√¨ c√†ng c·∫•t l·∫°i c√†ng th·∫•y?", o:["Ti·ªÅn", "C·∫•t nh√†", "C·∫•t r∆∞·ª£u", "B√≠ m·∫≠t"], c:1},
    {l:"easy", q:"Con g√¨ d√†i v√† c·ª©ng nh·∫•t?", o:["Con trƒÉn", "Con ƒë∆∞·ªùng", "Con l∆∞∆°n", "Con t√†u"], c:1},
    {l:"easy", q:"Con g√¨ sinh ra ƒë·∫°o ƒë·ª©c ƒë√£ kh√¥ng t·ªët?", o:["Con c√°o", "Con l·ª´a", "Con b√°o", "Con qu·ª∑"], c:1},
    {l:"easy", q:"G√† tr·ªëng v√† g√† m√°i thi b∆°i, con n√†o th·∫Øng?", o:["G√† tr·ªëng", "G√† m√°i", "H√≤a nhau", "G√† kh√¥ng bi·∫øt b∆°i"], c:3},
    {l:"easy", q:"Th√°ng n√†o con ng∆∞·ªùi ng·ªß √≠t nh·∫•t trong nƒÉm?", o:["Th√°ng 1", "Th√°ng 2 (√çt ng√†y nh·∫•t)", "Th√°ng 7", "Th√°ng 12"], c:1},
    {l:"easy", q:"T√≠ c√≥ 5 k·∫πo chia ƒë·ªÅu cho 5 b·∫°n. H·ªèi T√≠ c√≤n m·∫•y c√°i?", o:["1 c√°i", "0 c√°i", "5 c√°i", "2 c√°i"], c:1},
    {l:"easy", q:"Tr√™n l√¥ng d∆∞·ªõi l√¥ng / T·ªëi l·ªìng v√†o nhau... L√† g√¨?", o:["ƒê√¥i m·∫Øt", "Mi·ªáng", "B√†n tay", "C√°i k·∫πp t√≥c"], c:0},
    {l:"easy", q:"C√°i g√¨ c·ªßa ch·ªìng m√† v·ª£ th√≠ch c·∫ßm nh·∫•t (ƒë·ª´ng nghƒ© b·∫≠y)?", o:["Tay", "Ti·ªÅn", "ƒêi·ªán tho·∫°i", "Ch√¨a kh√≥a xe"], c:1},
    {l:"easy", q:"Con g√¨ mang ƒë∆∞·ª£c mi·∫øng g·ªó l·ªõn nh∆∞ng kh√¥ng mang ƒë∆∞·ª£c h√≤n s·ªèi?", o:["Con voi", "Con ki·∫øn", "Con s√¥ng", "Con c√°"], c:2},

    // MEDIUM (B·∫Øt ƒë·∫ßu hack n√£o)
    {l:"medium", q:"R·ªï c√≥ 3 qu·∫£ t√°o, chia cho 3 ng∆∞·ªùi m·ªói ng∆∞·ªùi 1 qu·∫£ m√† v·∫´n c√≤n 1 qu·∫£ trong r·ªï?", o:["Chia sai", "1 ng∆∞·ªùi l·∫•y nguy√™n c·∫£ r·ªï", "Qu·∫£ t√°o gi·∫£", "·∫¢o thu·∫≠t"], c:1},
    {l:"medium", q:"M√¥n th·ªÉ thao n√†o c√≥ c·∫£ vua l·∫´n ho√†ng h·∫≠u?", o:["B√≥ng ƒë√°", "C·ªù t∆∞·ªõng", "C·ªù vua", "B√†i t√¢y"], c:2},
    {l:"medium", q:"C√°i g√¨ c√†ng thiu l·∫°i c√†ng ngon?", o:["C∆°m", "Th·ªãt kho", "Gi·∫•c ng·ªß", "R∆∞·ª£u"], c:2},
    {l:"medium", q:"B√°nh g√¨ ƒÉn √≠t m√† nhi·ªÅu?", o:["B√°nh bao", "B√°nh ƒëa", "B√°nh √≠t", "B√°nh x√®o"], c:1},
    {l:"medium", q:"C√°i g√¨ tay ph·∫£i c·∫ßm ƒë∆∞·ª£c m√† tay tr√°i c·∫ßm kh√¥ng ƒë∆∞·ª£c?", o:["C√πi ch·ªè tr√°i", "C√°nh tay tr√°i", "C√°nh tay ph·∫£i", "L·ªó tai tr√°i"], c:1},
    {l:"medium", q:"Tr∆∞·ªõc m·∫∑t l√† qu·∫£ng tr∆∞·ªùng xanh, sau l∆∞ng l√† tr·∫Øng. Qu·∫£ng tr∆∞·ªùng ƒê·ªè ·ªü ƒë√¢u?", o:["·ªû Nga", "·ªû M·ªπ", "·ªû Ph√°p", "·ªû Vi·ªát Nam"], c:0},
    {l:"medium", q:"T·ªëc ƒë·ªô quy ƒë·ªãnh t·ªëi ƒëa trong thi ch·∫°y marathon l√† bao nhi√™u?", o:["20 km/h", "30 km/h", "40 km/h", "Kh√¥ng gi·ªõi h·∫°n"], c:3},
    {l:"medium", q:"Khi n√†o nh√¨n v√†o s·ªë 2 nh∆∞ng l·∫°i n√≥i l√† 10?", o:["Nh√¨n ƒë·ªìng h·ªì (Kim ph√∫t)", "Nh√¨n l·ªãch", "Nh√¨n b√†i thi", "Nh√¨n bi·ªÉn s·ªë xe"], c:0},
    {l:"medium", q:"B√°nh g√¨ tr√≤n nh∆∞ m·∫∑t trƒÉng?", o:["B√°nh trung thu", "B√°nh x√®o", "B√°nh b√≤", "B√°nh b√®o"], c:1},
    {l:"medium", q:"C∆° quan quan tr·ªçng nh·∫•t c·ªßa ph·ª• n·ªØ l√† g√¨?", o:["Tr√°i tim", "B·ªô n√£o", "H·ªôi Li√™n Hi·ªáp Ph·ª• N·ªØ", "D·∫° d√†y"], c:2},
    {l:"medium", q:"Th√¢n anh tr√πng tr·ª•c tr∆°n lu / M·∫•y em m√∫t ƒë·∫øn anh tr√†o n∆∞·ªõc ra?", o:["Vi√™n k·∫πo", "M√≠a", "Que kem", "ƒê√° b√†o"], c:2},
    {l:"medium", q:"Con g√¨ kh√¥ng c√≥ x∆∞∆°ng s·ªëng m√† v·∫´n ƒë·ª©ng ƒë∆∞·ª£c?", o:["Con giun", "Con d·ªëc", "Con r·∫Øn", "Con n·ªôm"], c:1},
    {l:"medium", q:"C√°i g√¨ 2 l·ªó: c√≥ gi√≥ th√¨ s·ªëng, kh√¥ng gi√≥ th√¨ ch·∫øt?", o:["L·ªó m≈©i", "L·ªó tai", "C·ª≠a s·ªï", "Bong b√≥ng"], c:0},
    {l:"medium", q:"B√¥ng g√¨ kh√¥ng m·ªçc t·ª´ c√¢y?", o:["B√¥ng h·ªìng", "B√¥ng tai", "B√¥ng s√∫ng", "B√¥ng c·∫£i"], c:1},
    {l:"medium", q:"Con g√¨ sinh ra ƒë√£ ƒë∆∞·ª£c l√†m vua?", o:["Con s∆∞ t·ª≠", "Con cua ho√†ng ƒë·∫ø", "Con r·ªìng", "Con h·ªï"], c:1},

    // HARD (Si√™u b·ª±a & Logic)
    {l:"hard", q:"1 th·∫±ng m√π v√† ba th·∫±ng ƒëi·∫øc ƒëi ƒÉn ph·ªü (10k/t√¥). H·ªèi ph·∫£i tr·∫£ bao nhi√™u?", o:["40 ng√†n", "30 ng√†n", "20 ng√†n (Ba c·ªßa th·∫±ng ƒëi·∫øc)", "10 ng√†n"], c:2},
    {l:"hard", q:"N∆°i n√†o 'h√¥m nay' ƒëi tr∆∞·ªõc 'h√¥m qua' (Where does today come before yesterday)?", o:["Trong t·ª´ ƒëi·ªÉn (Dictionary)", "Trong l·ªãch", "Trong m∆°", "·ªû n∆∞·ªõc √öc"], c:0},
    {l:"hard", q:"C·∫Øt 1 kh√∫c v·∫£i th√†nh 100 kh√∫c, m·ªói l·∫ßn c·∫Øt 5 gi√¢y. H·ªèi c·∫Øt xong m·∫•t bao l√¢u?", o:["500 gi√¢y", "495 gi√¢y (99 l·∫ßn c·∫Øt)", "490 gi√¢y", "450 gi√¢y"], c:1},
    {l:"hard", q:"3 th·∫±ng l√πn ƒëi v√†o hang: c·∫ßm x√¥, c·∫ßm x·∫ªng. Th·∫±ng ƒëi ƒë·∫ßu c·∫ßm g√¨?", o:["C·∫ßm ƒë√®n", "C·∫ßm ƒëu·ªëc", "C·∫ßm ƒë·∫ßu (ƒê·∫°i ca)", "C·∫ßm tay"], c:2},
    {l:"hard", q:"C√°i g√¨ kh√¥ng c√≥ ch√¢n, tay, ƒëu√¥i nh∆∞ng c√≥ r·∫•t nhi·ªÅu ƒë·∫ßu?", o:["Con r·ªìng", "C·∫ßu truy·ªÅn h√¨nh", "ƒê√°m ƒë√¥ng", "Qu√°i v·∫≠t"], c:1},
    {l:"hard", q:"Tr√≤ g√¨ 5 b√© h∆°n 2, 2 b√© h∆°n 0 v√† 0 b√© h∆°n 5?", o:["Tr·ªën t√¨m", "√î ƒÉn quan", "O·∫≥n t√π x√¨", "ƒê√°nh b√†i"], c:2},
    {l:"hard", q:"Lan c√≥ 2 s√°ch, ng√†y k·∫ø m·∫π cho 9 s√°ch. M·ªói ng√†y Lan ƒë·ªçc 1 quy·ªÉn. Sau ng√†y th·ª© 7 Lan ƒë·ªçc m·∫•y quy·ªÉn?", o:["8 quy·ªÉn (2 c≈© + 6 ng√†y)", "7 quy·ªÉn", "9 quy·ªÉn", "11 quy·ªÉn"], c:0},
    {l:"hard", q:"Tr√™n thon d∆∞·ªõi ph·ªìng / ƒê·∫ßu ƒë·ªôi n√≥n ƒë·ªìng, khi s√°ng khi t·ªëi?", o:["C√¢y n·∫øn", "B√≥ng ƒë√®n", "ƒêom ƒë√≥m", "Ng·ªçn ƒëu·ªëc"], c:1},
    {l:"hard", q:"Tr√≤n nh∆∞ l√° t√≠a t√¥ / B∆∞·ªõc c·∫≥ng v√¥ h·ªì, trong kh√¥ ngo√†i ∆∞·ªõt?", o:["C√°i g√°o (m√∫c n∆∞·ªõc)", "C√°i thuy·ªÅn", "C√°i n√≥n", "ƒê√¥i ·ªßng"], c:0},
    {l:"hard", q:"L·ªìm x·ªìm 2 m√©p nh·ªØng l√¥ng / ·ªû gi·ªØa c√≥ l·ªó ƒë√†n √¥ng chui v√†o?", o:["C√°i √°o len", "C√°i √°o m∆∞a (ng√†y x∆∞a)", "C√°i l·ªÅu", "C√°i hang"], c:1},
    {l:"hard", q:"D√†i nh∆∞ tr√°i chu·ªëi t√¢y / M·ªôt ƒë·∫ßu c·ª©ng ng·∫Øc, ƒë·∫ßu ƒë·∫ßy l√¥ng quƒÉn?", o:["B√†n ch·∫£i", "B·∫Øp ng√¥", "C√¢y b√∫t", "C·ªß c√† r·ªët"], c:1},
    {l:"hard", q:"ƒê√∫t v√†o nh√® nh·∫π ngo√°y nghe anh / Cho em t√™ m√™ t·∫≠n m√¢y xanh?", o:["Ngo√°y m≈©i", "Ngo√°y tai", "G√£i l∆∞ng", "X√¢u kim"], c:1},
    {l:"hard", q:"Ai mu·ªën di·ªán ki·∫øn vua ph·∫£i n√≥i 1 c√¢u: Th·∫≠t th√¨ ch√©m, d·ªëi th√¨ treo c·ªï. N√≥i c√¢u g√¨ ƒë·ªÉ s·ªëng?", o:["T√¥i s·∫Ω b·ªã ch√©m", "T√¥i s·∫Ω b·ªã treo c·ªï", "T√¥i v√¥ t·ªôi", "T√¥i mu·ªën g·∫∑p vua"], c:1},
    {l:"hard", q:"ƒê·ªÉ y√™n n·∫±m im thin th√≠t / H·ªÖ ƒë·ªông li·∫øm ƒë√≠t, ch·∫°y t·ª© tung?", o:["Con ch√≥", "Con tem", "C√°i xe", "Vi√™n bi"], c:1},
    {l:"hard", q:"Xe n√†o kh√¥ng bao gi·ªù gi·∫£m ƒëi?", o:["Xe ƒë·∫°p", "Xe m√°y", "Xe tƒÉng", "Xe bu√Ωt"], c:2}
];

/* ================== GAME LOGIC ================== */
const game = {
    index: 0,
    pack: [],
    timer: 20,
    interval: null,
    lockedIds: JSON.parse(localStorage.getItem("NCT_MASTER") || "[]"),
    user: { name: "", gender: "other" },
    lifelines: { '5050': true, 'phone': true, 'audience': true, 'expert': true },
    isPaused: false, // ƒê·ªÉ t·∫°m d·ª´ng th·ªùi gian khi hi·ªán g·ª£i √Ω

    start() {
        const name = document.getElementById('inp-name').value.trim();
        if(!name){ alert("Nh·∫≠p c√°i t√™n v√†o ƒë√£ b·∫°n ∆°i!"); return; }

        this.user.name = name;
        this.user.gender = this.detectGender(name);
        
        // Reset lifelines UI
        document.querySelectorAll('.life-btn').forEach(btn => btn.classList.remove('used'));
        this.lifelines = { '5050': true, 'phone': true, 'audience': true, 'expert': true };

        this.pack = this.buildPack();
        if(this.pack.length < 15) {
            if(confirm("H·∫øt c√¢u h·ªèi r·ªìi! Reset ƒë·ªÉ ch∆°i l·∫°i t·ª´ ƒë·∫ßu nh√©?")) {
                localStorage.removeItem("NCT_MASTER");
                location.reload();
            }
            return;
        }

        document.getElementById('screen-start').classList.add('hidden');
        document.getElementById('screen-play').classList.remove('hidden');
        document.getElementById('player-display').innerText = `Ng∆∞·ªùi ch∆°i: ${this.user.name}`;
        
        this.loadQuestion();
    },

    // AI Detect Gender Logic (Optimized for First Name)
    detectGender(name) {
        const n = name.toLowerCase();
        const males = ['h√πng','c∆∞·ªùng','d≈©ng','nam','t√πng','s∆°n','ƒë·ª©c','th·∫Øng','minh','hi·∫øu','huy','long','kh√°nh','ƒë·∫°t','tu·∫•n','trung','th√†nh','quang','vinh','ki√™n','ho√†ng','ph√∫c','l√¢m','khoa','vi·ªát','t√†i','h·∫£i','nghƒ©a','b·∫£o'];
        const females = ['lan','hu·ªá','mai','c√∫c','tr√∫c','ƒë√†o','ly','h∆∞∆°ng','h·∫±ng','huy·ªÅn','trang','th·∫£o','vy','linh','ph∆∞∆°ng','nhung','thu','th·ªßy','h√†','h·∫°nh','hi·ªÅn','dung','trinh','tuy·∫øt','nhi','h√¢n','th∆∞','y·∫øn','qu·ª≥nh','hoa','tr√¢m','uy√™n','di·ªÖm','th√∫y','ki·ªÅu','nga','ng√¢n','ch√¢u','anh','oanh','v√¢n'];
        
        if(males.includes(n)) return 'male';
        if(females.includes(n)) return 'female';
        return 'other';
    },

    buildPack() {
        const available = DB.filter(q => !this.lockedIds.includes(q.q));
        const get = (lvl, n) => available.filter(q => q.l === lvl).sort(() => Math.random() - 0.5).slice(0, n);
        const pack = [...get('easy',5), ...get('medium',5), ...get('hard',5)];
        return pack.length === 15 ? pack : [];
    },

    loadQuestion() {
        clearInterval(this.interval);
        this.isPaused = false;
        const q = this.pack[this.index];
        this.timer = 20;
        
        document.getElementById('timer').innerText = this.timer;
        document.getElementById('progress').innerText = `C√ÇU ${this.index + 1}/15`;
        document.getElementById('question').innerText = q.q;
        document.getElementById('explain').classList.add('hidden');
        
        const optBox = document.getElementById('options');
        optBox.innerHTML = '';
        optBox.classList.remove('disabled');

        q.o.forEach((t, i) => {
            const div = document.createElement('div');
            div.className = 'option';
            div.innerHTML = `<b style="color:var(--gold); margin-right:10px">${String.fromCharCode(65+i)}.</b> ${t}`;
            div.onclick = () => this.check(i);
            optBox.appendChild(div);
        });

        this.interval = setInterval(() => {
            if(!this.isPaused) {
                this.timer--;
                document.getElementById('timer').innerText = this.timer;
                if(this.timer <= 0) this.lose(true);
            }
        }, 1000);
    },

    /* === 4 QUY·ªÄN TR·ª¢ GI√öP (ƒê·∫¢M B·∫¢O QUA) === */
    
    // 1. 50:50
    life5050() {
        if(!this.lifelines['5050']) return;
        this.markUsed('btn-5050', '5050');
        const q = this.pack[this.index];
        const wrongIdx = [0,1,2,3].filter(i => i !== q.c).sort(()=>Math.random()-0.5).slice(0,2);
        const opts = document.querySelectorAll('.option');
        wrongIdx.forEach(i => opts[i].classList.add('hidden-50'));
    },

    // 2. G·ªçi ƒëi·ªán (Ch·ªâ th·∫≥ng ƒë√°p √°n)
    lifePhone() {
        if(!this.lifelines['phone']) return;
        this.markUsed('btn-phone', 'phone');
        this.isPaused = true;
        
        const q = this.pack[this.index];
        const letter = String.fromCharCode(65 + q.c);
        const ans = q.o[q.c];
        
        let msg = "";
        if(this.user.gender === 'male') msg = `Alo ƒë·∫°i ca √†? Em tra Google r·ªìi, ch·∫Øc ch·∫Øn l√† <b>${letter}: ${ans}</b> nh√©. Sai ch·∫∑t ƒë·∫ßu em ƒëi!`;
        else if(this.user.gender === 'female') msg = `Ch·ªã ƒë·∫πp ∆°i, em h·ªèi c·∫£ l√†ng r·ªìi. ƒê√°p √°n l√† <b>${letter}: ${ans}</b> nh√©. Ch·ªçn sai l√† em d·ªói ƒë·∫•y!`;
        else msg = `Alo, theo ngu·ªìn tin m·∫≠t t·ª´ NASA th√¨ ƒë√°p √°n l√† <b>${letter}: ${ans}</b> nh√© b·∫°n m√¨nh ∆°i!`;

        this.showOverlay("üìû NG∆Ø·ªúI TH√ÇN M√ÅCH N∆Ø·ªöC", msg);
    },

    // 3. Kh√°n gi·∫£ (Bi·ªÉu ƒë·ªì ch·ªâ th·∫≥ng ƒë√°p √°n)
    lifeAudience() {
        if(!this.lifelines['audience']) return;
        this.markUsed('btn-audience', 'audience');
        this.isPaused = true;
        
        const q = this.pack[this.index];
        let stats = [0,0,0,0];
        // T·∫°o ch·ªâ s·ªë ·∫£o: ƒê√°p √°n ƒë√∫ng 85-95%, c√≤n l·∫°i chia nhau
        stats[q.c] = Math.floor(Math.random() * 10) + 85; 
        let remain = 100 - stats[q.c];
        for(let i=0; i<4; i++) {
            if(i !== q.c) {
                let v = Math.floor(Math.random() * remain);
                stats[i] = v;
                remain -= v;
            }
        }
        
        let chartHTML = `<div style="display:flex; justify-content:space-around; align-items:flex-end; height:150px; margin-top:20px;">`;
        stats.forEach((val, i) => {
            const isC = i === q.c;
            chartHTML += `
                <div style="width:40px; text-align:center;">
                    <div style="height:${val}px; background:${isC ? 'var(--green)' : '#555'}; margin:0 auto; width:20px; border-radius:3px 3px 0 0;"></div>
                    <div style="margin-top:5px; font-weight:bold;">${String.fromCharCode(65+i)}</div>
                    <div style="font-size:0.8em; color:${isC ? 'var(--green)':'#aaa'}">${val}%</div>
                </div>`;
        });
        chartHTML += `</div>`;
        
        this.showOverlay("üë• √ù KI·∫æN KH√ÅN GI·∫¢", `Kh√°n gi·∫£ t·∫°i tr∆∞·ªùng quay ƒë√£ b√¨nh ch·ªçn:<br>${chartHTML}`);
    },

    // 4. T·ªï t∆∞ v·∫•n (Chuy√™n gia ph√°n)
    lifeExpert() {
        if(!this.lifelines['expert']) return;
        this.markUsed('btn-expert', 'expert');
        this.isPaused = true;
        
        const q = this.pack[this.index];
        const letter = String.fromCharCode(65 + q.c);
        
        const content = `
            <div style="text-align:left; background:rgba(255,255,255,0.1); padding:10px; border-radius:5px; margin-bottom:5px;">
                üßî <b>GS. Xoay:</b> "C√¢u n√†y t√¥i nghi√™n c·ª©u 10 nƒÉm r·ªìi, ch·∫Øc ch·∫Øn l√† <b>${letter}</b>."
            </div>
            <div style="text-align:left; background:rgba(255,255,255,0.1); padding:10px; border-radius:5px;">
                üë©‚Äçüè´ <b>TS. NCT9x:</b> "ƒê·ªìng √Ω ho√†n to√†n! Ch·ªçn <b>${letter}</b> l√† qua m√†n nh√©!"
            </div>
        `;
        this.showOverlay("üßô T·ªî T∆Ø V·∫§N", content);
    },

    markUsed(btnId, key) {
        document.getElementById(btnId).classList.add('used');
        this.lifelines[key] = false;
    },

    showOverlay(title, content) {
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('overlay-title').innerHTML = title;
        document.getElementById('overlay-content').innerHTML = content;
    },

    closeOverlay() {
        document.getElementById('overlay').classList.add('hidden');
        this.isPaused = false; // Ti·∫øp t·ª•c ƒë·∫øm gi·ªù
    },

    /* === CHECK & RESULT LOGIC === */
    check(i) {
        clearInterval(this.interval);
        const q = this.pack[this.index];
        const opts = document.querySelectorAll('.option');
        document.getElementById('options').classList.add('disabled');

        if(i === q.c) {
            opts[i].classList.add('correct');
            this.index++;
            setTimeout(() => {
                if(this.index === 15) this.win();
                else this.loadQuestion();
            }, 1000);
        } else {
            opts[i].classList.add('wrong');
            opts[q.c].classList.add('correct');
            this.saveProgress();
            setTimeout(() => this.lose(false), 2000);
        }
    },

    saveProgress() {
        const passed = this.pack.slice(0, this.index).map(q => q.q);
        this.lockedIds = [...new Set([...this.lockedIds, ...passed])];
        localStorage.setItem("NCT_MASTER", JSON.stringify(this.lockedIds));
    },

    lose(timeout) {
        const p = this.getPronoun();
        const n = this.user.name;
        let msg = "";

        if(this.index < 5) {
            if(this.user.gender === 'male') msg = `ƒê·∫°i ca ${n} ∆°i! C√¢u d·ªÖ th·∫ø n√†y m√† c≈©ng sai th√¨ h·ªèng h·∫øt b√°nh k·∫πo r·ªìi! üòÇ`;
            else if(this.user.gender === 'female') msg = `Ch·ªã ${n} xinh g√°i m√† sai c√¢u n√†y th√¨ ti·∫øc qu√° ƒëi m·∫•t! üíÑ`;
            else msg = `C√¢u n√†y tr·∫ª con c≈©ng bi·∫øt m√† b·∫°n ${n} l·∫°i sai ∆∞? Bu·ªìn gh√™!`;
        } else if (this.index < 10) {
            if(timeout) msg = `H·∫øt gi·ªù r·ªìi ${p} ${n} ∆°i! M·∫£i suy nghƒ© chuy·ªán kh√°c ph·∫£i kh√¥ng?`;
            else msg = `Sai m·ªôt ly ƒëi m·ªôt d·∫∑m. ${p} ${n} c·∫ßn b√¨nh tƒ©nh h∆°n nh√©!`;
        } else {
            msg = `Tr·ªùi ∆°i ti·∫øc qu√°! ${p} ${n} su√Ωt th√¨ th√†nh Huy·ªÅn Tho·∫°i r·ªìi.`;
        }
        this.endScreen(timeout ? "‚åõ H·∫æT GI·ªú" : "üíÄ GAME OVER", msg);
    },

    win() {
        this.saveProgress();
        const n = this.user.name;
        let msg = "";
        if(this.user.gender === 'male') msg = `ƒê·ªânh cao tr√≠ tu·ªá! ƒê·∫°i ca ${n} x·ª©ng danh l√† gi√°o s∆∞ bi·∫øt tu·ªët! üèÜ`;
        else if(this.user.gender === 'female') msg = `Tuy·ªát v·ªùi! N·ªØ th·∫ßn ${n} v·ª´a xinh v·ª´a gi·ªèi, ai m√† ch·ªãu n·ªïi! üëë`;
        else msg = `15/15! B·∫°n ${n} ch√≠nh l√† b·ªô n√£o thi√™n t√†i m√† NCT9x t√¨m ki·∫øm!`;

        this.endScreen("üëë HUY·ªÄN THO·∫†I", msg);
    },

    getPronoun() {
        if(this.user.gender === 'male') return "anh";
        if(this.user.gender === 'female') return "ch·ªã";
        return "b·∫°n";
    },

    endScreen(title, msg) {
        clearInterval(this.interval);
        document.getElementById('screen-play').classList.add('hidden');
        document.getElementById('screen-result').classList.remove('hidden');
        document.getElementById('res-title').innerText = title;
        document.getElementById('res-msg').innerHTML = msg;
    }
};

function handleEnter(e) { if(e.key === 'Enter') game.start(); }
// Focus input
document.getElementById('inp-name').focus();
</script>
</body>
</html>
