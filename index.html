<script>
const LOCK_KEY = "LOCKED_QUESTION_IDS";
let lockedIds = JSON.parse(localStorage.getItem(LOCK_KEY) || "[]");

let pack = [];
let index = 0;
let usedHelp = false;

/* ===== BUILD PACK 15 CÃ‚U ===== */
function buildPack() {
  const pick = (level, n) =>
    QUESTIONS.filter(q =>
      q.level === level &&
      !lockedIds.includes(q.id)
    ).sort(() => Math.random() - 0.5).slice(0, n);

  const p = [
    ...pick("easy", 5),
    ...pick("medium", 5),
    ...pick("hard", 5)
  ];

  if (p.length < 15) {
    alert("Kho cÃ¢u há»i sáº¯p háº¿t. Tá»± Ä‘á»™ng lÃ m má»›i!");
    localStorage.removeItem(LOCK_KEY);
    location.reload();
  }
  return p;
}

/* ===== START ===== */
function startGame() {
  pack = buildPack();
  index = 0;
  usedHelp = false;
  show("play");
  loadQ();
}

/* ===== LOAD QUESTION ===== */
function loadQ() {
  const q = pack[index];
  progress.innerText = `CÃ¢u ${index + 1}/15`;
  question.innerText = q.q;
  options.innerHTML = "";

  q.o.forEach((t, i) => {
    const d = document.createElement("div");
    d.className = "option";
    d.innerText = t;
    d.onclick = () => answer(i);
    options.appendChild(d);
  });

  explain.classList.add("hidden");
  stopBtn.classList.toggle("hidden", index < 9);
}

/* ===== ANSWER ===== */
function answer(i) {
  const q = pack[index];

  if (!q.c.includes(i)) {
    lockAnswered();
    return showResult("lose");
  }

  index++;
  if (index === 15) {
    lockAnswered(true);
    return showResult("win");
  }
  loadQ();
}

/* ===== KHÃ“A NHá»®NG CÃ‚U ÄÃƒ CHáº M ===== */
function lockAnswered(all = false) {
  const touched = all ? pack : pack.slice(0, index + 1);
  touched.forEach(q => {
    if (!lockedIds.includes(q.id)) lockedIds.push(q.id);
  });
  localStorage.setItem(LOCK_KEY, JSON.stringify(lockedIds));
}

/* ===== STOP ===== */
function stopGame() {
  showResult("stop");
}

/* ===== RESULT ===== */
function showResult(type) {
  show("result");

  if (type === "win") {
    resultTitle.innerText = "ğŸ‘‘ HUYá»€N THOáº I!";
    resultMsg.innerText = "15/15 â€“ WOW! NÃ£o báº¡n Ä‘Ãºng lÃ  quÃ¡i váº­t ğŸ§ ğŸ”¥";
  }
  else if (type === "stop") {
    resultTitle.innerText = "â¹ï¸ Dá»ªNG CUá»˜C CHÆ I";
    resultMsg.innerText = `Báº¡n dá»«ng á»Ÿ cÃ¢u ${index + 1}. KhÃ´n Ä‘áº¥y!`;
  }
  else {
    resultTitle.innerText = "ğŸ’€ THUA CUá»˜C";
    if (index < 9) {
      resultMsg.innerText =
        "Ãˆoâ€¦ báº¡n cÃ²n khÃ´ng thÃ´ng minh hÆ¡n há»c sinh lá»›p 5 ğŸ˜­";
    } else {
      resultMsg.innerText =
        `Dá»«ng chÃ¢n á»Ÿ cÃ¢u ${index + 1}. CÅ©ng cÄƒng!`;
    }
  }
}

/* ===== UI HELPER ===== */
function show(id){
  start.classList.add("hidden");
  play.classList.add("hidden");
  result.classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}
</script>
